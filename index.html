<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Synchrone - Debug</title>
    <!-- CHANGEMENT CDN : Utilisation de Cloudflare (plus stable) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --bg: #f8fafc;
            --text: #1e293b;
            --error: #ef4444;
            --success: #22c55e;
        }
        body { background-color: var(--bg); color: var(--text); font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; }
        
        .container { max-width: 500px; margin: 0 auto; width: 100%; flex: 1; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        
        /* UI ELEMENTS */
        .btn { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 8px; font-size: 1.1rem; cursor: pointer; margin-top: 10px; width: 100%; font-weight: bold; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background: #ccc; }
        
        input { padding: 15px; border: 2px solid #ccc; border-radius: 8px; width: 100%; font-size: 1.2rem; text-align: center; margin-bottom: 10px; box-sizing: border-box; }
        input:focus { border-color: var(--primary); outline: none; }

        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; margin-bottom: 20px; }
        .big-text { font-size: 2rem; font-weight: bold; margin: 10px 0; color: var(--primary); }

        /* LOGS CONSOLE VISUELLE */
        #debug-log {
            background: #1e1e1e; color: #00ff00; font-family: monospace; font-size: 12px;
            padding: 10px; border-radius: 8px; height: 150px; overflow-y: auto; margin-top: auto;
            border: 2px solid #444; white-space: pre-wrap;
        }
        .log-error { color: #ff4444; font-weight: bold; }
        .log-info { color: #aaaaaa; }
        .log-success { color: #00ff00; }

        /* ZONE JEU */
        .game-row { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 15px; }
        .player-card { background: white; padding: 15px; border-radius: 8px; flex: 1; text-align: center; border: 2px solid transparent; }
        .player-card.active { border-color: var(--primary); }
        .player-card.ready { border-color: var(--success); background: #f0fdf4; }
        .player-card.win { border-color: gold; background: #fffbeb; animation: pulse 1s infinite; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); } }
    </style>
</head>
<body>

<div class="container">
    
    <!-- ECRAN LOBBY -->
    <div id="lobby-screen" class="card">
        <h1>Synchrone üß†</h1>
        <p>Version Diagnostic</p>
        
        <button class="btn" onclick="initGame()">Cr√©er une salle</button>
        
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
        
        <input type="text" id="join-input" placeholder="Code (ex: 84219)">
        <button class="btn" style="background: white; color: black; border: 1px solid #ccc;" onclick="joinGame()">Rejoindre</button>

        <div id="my-code-display" class="hidden" style="margin-top: 20px;">
            <p>Votre code :</p>
            <div class="big-text" id="code-text">---</div>
            <button class="btn" onclick="copyCode()">Copier le code</button>
        </div>
    </div>

    <!-- ECRAN JEU -->
    <div id="game-screen" class="hidden">
        <div class="game-row">
            <div class="player-card" id="card-opp">
                <div>Adversaire</div>
                <div id="word-opp" class="big-text">...</div>
                <div id="status-opp" style="font-size: 0.9rem; color: #666;">En attente</div>
            </div>
        </div>

        <div class="game-row">
            <div class="player-card active" id="card-me">
                <div>Moi</div>
                <div id="word-me" class="big-text">?</div>
                <input type="text" id="my-word" placeholder="Votre mot..." autocomplete="off" style="margin-top: 10px;">
                <button class="btn" id="btn-submit" onclick="submitWord()">Valider</button>
                <button class="btn hidden" id="btn-restart" onclick="restartGame()">Rejouer</button>
            </div>
        </div>
        
        <!-- Chat simplifi√© -->
        <div style="margin-top: 10px; display:flex; gap:5px;">
            <input type="text" id="chat-input" placeholder="Chat..." style="padding: 10px; font-size: 0.9rem;">
            <button class="btn" style="width: auto; padding: 0 15px;" onclick="sendChat()">Envoyer</button>
        </div>
        <div id="chat-box" style="height: 60px; overflow-y: auto; background: #f1f5f9; border-radius: 8px; padding: 5px; font-size: 0.8rem; margin-bottom: 10px;"></div>
    </div>

    <!-- CONSOLE DE DEBUG -->
    <div id="debug-log">Journal syst√®me en attente...</div>
</div>

<script>
    // --- LOGS ---
    function log(msg, type = 'normal') {
        const box = document.getElementById('debug-log');
        const time = new Date().toLocaleTimeString();
        let colorClass = '';
        if(type === 'error') colorClass = 'log-error';
        else if(type === 'success') colorClass = 'log-success';
        else if(type === 'info') colorClass = 'log-info';
        
        box.innerHTML += `<div class="${colorClass}">[${time}] ${msg}</div>`;
        box.scrollTop = box.scrollHeight;
        console.log(msg);
    }

    // --- VERIFICATION INITIALISATION ---
    window.onload = function() {
        if (typeof Peer === 'undefined') {
            log("ERREUR CRITIQUE : La librairie PeerJS n'a pas pu √™tre charg√©e.", "error");
            log("Cause probable : Adblock ou pare-feu entreprise bloquant 'cdnjs.cloudflare.com'.", "error");
            alert("Erreur : Le script du jeu est bloqu√© par votre navigateur/r√©seau.");
        } else {
            log("Librairie charg√©e avec succ√®s.", "success");
        }
    };

    let peer = null;
    let conn = null;
    let myCode = null;
    
    const state = { myWord: "", oppWord: "", amReady: false, oppReady: false };
    
    // --- CREATION SALLE (ID COURT) ---
    function initGame() {
        document.getElementById('lobby-screen').querySelector('button').disabled = true;
        document.getElementById('lobby-screen').querySelector('button').textContent = "Recherche d'un ID libre...";
        
        tryShortId(0);
    }

    function tryShortId(attempt) {
        if (attempt > 15) {
            log("Trop de tentatives √©chou√©es. Serveur satur√© ?", "error");
            alert("Impossible de cr√©er un code libre. R√©essayez dans 2 minutes.");
            location.reload();
            return;
        }

        // G√©n√©ration ID 5 chiffres
        const shortId = Math.floor(10000 + Math.random() * 90000).toString();
        log(`Tentative ID Court : ${shortId}...`, "info");

        // Configuration PeerJS robuste
        peer = new Peer(shortId, {
            debug: 1,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        });

        peer.on('open', (id) => {
            log(`ID Cr√©√© avec succ√®s : ${id}`, "success");
            myCode = id;
            document.getElementById('code-text').textContent = myCode;
            document.getElementById('my-code-display').classList.remove('hidden');
            document.querySelector('.lobby-actions')?.remove(); // Nettoyage UI
            
            peer.on('connection', (c) => {
                log("Un joueur arrive !", "success");
                setupConnection(c);
            });
        });

        peer.on('error', (err) => {
            if (err.type === 'unavailable-id') {
                log(`ID ${shortId} d√©j√† pris. R√©essai...`, "info");
                peer.destroy();
                tryShortId(attempt + 1);
            } else {
                log(`Erreur PeerJS : ${err.type}`, "error");
                log(`D√©tail : ${err.message}`, "error");
            }
        });
    }

    // --- REJOINDRE ---
    function joinGame() {
        const targetId = document.getElementById('join-input').value.trim();
        if (!targetId) return alert("Entrez un code");

        log(`Tentative de connexion au code ${targetId}...`, "info");

        peer = new Peer({
            debug: 1,
            config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
        });

        peer.on('open', () => {
            log("Connect√© au serveur de signalisation.", "success");
            const c = peer.connect(targetId);
            setupConnection(c);
        });

        peer.on('error', (err) => {
            log(`Erreur connexion : ${err.type}`, "error");
            if(err.type === 'peer-unavailable') {
                alert("Ce code n'existe pas ou n'est plus en ligne.");
            } else {
                alert("Erreur de connexion r√©seau.");
            }
        });
    }

    function setupConnection(c) {
        conn = c;
        
        conn.on('open', () => {
            log("CANAL P2P OUVERT. Jeu pr√™t.", "success");
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
        });

        conn.on('data', (data) => handleData(data));
        conn.on('close', () => {
            log("D√©connect√© par l'autre joueur.", "error");
            location.reload();
        });
        conn.on('error', (err) => {
            log(`Erreur DataChannel : ${err.type}`, "error");
        });
    }

    // --- JEU ---
    function handleData(data) {
        if (data.type === 'COMMIT') {
            state.oppWord = data.word;
            state.oppReady = true;
            document.getElementById('word-opp').textContent = "PR√äT";
            document.getElementById('card-opp').classList.add('ready');
            document.getElementById('status-opp').textContent = "Mot entr√©";
            log("Adversaire a valid√© son mot.", "info");
            checkResult();
        }
        else if (data.type === 'CHAT') {
            const box = document.getElementById('chat-box');
            box.innerHTML += `<div style="color:blue;">Lui: ${data.msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }
        else if (data.type === 'RESET') {
            restartGameUI();
        }
    }

    function submitWord() {
        const w = document.getElementById('my-word').value.trim();
        if (!w) return;

        state.myWord = w;
        state.amReady = true;
        
        document.getElementById('my-word').disabled = true;
        document.getElementById('my-word').classList.add('hidden');
        document.getElementById('btn-submit').classList.add('hidden');
        document.getElementById('word-me').textContent = "PR√äT";
        document.getElementById('card-me').classList.add('ready');

        conn.send({ type: 'COMMIT', word: w });
        log("Mon mot envoy√©.", "info");
        checkResult();
    }

    function checkResult() {
        if (state.amReady && state.oppReady) {
            log("R√©v√©lation des mots...", "info");
            
            document.getElementById('word-me').textContent = state.myWord;
            document.getElementById('word-opp').textContent = state.oppWord;
            
            const isWin = state.myWord.toLowerCase() === state.oppWord.toLowerCase();
            
            if (isWin) {
                log("VICTOIRE ! Mots identiques.", "success");
                document.getElementById('card-me').classList.add('win');
                document.getElementById('card-opp').classList.add('win');
                document.getElementById('status-opp').textContent = "SYNCHRONIS√âS !";
            } else {
                log("D√âFAITE. Mots diff√©rents.", "error");
                document.getElementById('status-opp').textContent = "RAT√â";
            }

            document.getElementById('btn-restart').classList.remove('hidden');
        }
    }

    function restartGame() {
        conn.send({ type: 'RESET' });
        restartGameUI();
    }

    function restartGameUI() {
        state.myWord = ""; state.oppWord = ""; state.amReady = false; state.oppReady = false;
        
        document.getElementById('my-word').value = "";
        document.getElementById('my-word').disabled = false;
        document.getElementById('my-word').classList.remove('hidden');
        document.getElementById('btn-submit').classList.remove('hidden');
        document.getElementById('btn-restart').classList.add('hidden');
        
        document.getElementById('word-me').textContent = "?";
        document.getElementById('word-opp').textContent = "...";
        document.getElementById('status-opp').textContent = "En attente";
        
        document.getElementById('card-me').classList.remove('ready', 'win');
        document.getElementById('card-opp').classList.remove('ready', 'win');
        
        log("Jeu r√©initialis√©.", "info");
    }

    function sendChat() {
        const msg = document.getElementById('chat-input').value.trim();
        if (!msg || !conn) return;
        
        conn.send({ type: 'CHAT', msg: msg });
        const box = document.getElementById('chat-box');
        box.innerHTML += `<div style="text-align:right;">Moi: ${msg}</div>`;
        document.getElementById('chat-input').value = "";
        box.scrollTop = box.scrollHeight;
    }

    function copyCode() {
        navigator.clipboard.writeText(myCode).then(() => alert("Code copi√© !"));
    }
</script>

</body>
</html>
